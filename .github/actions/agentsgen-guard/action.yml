name: "agentsgen-guard"
description: "PR guard: fail if AGENTS.md/RUNBOOK.md are missing or out of date (using agentsgen check)."
author: "abvx / markoblogo"

inputs:
  path:
    description: "Working directory to run agentsgen in"
    required: false
    default: "."
  files:
    description: "Comma/newline-separated list of files to check"
    required: false
    default: "AGENTS.md,RUNBOOK.md"
  comment:
    description: "If true, post/update a PR comment when failing (best-effort)"
    required: false
    default: "false"
  token:
    description: "GitHub token used for PR commenting when comment=true"
    required: false
    default: "${{ github.token }}"
  show_commands:
    description: "If true, print remediation commands"
    required: false
    default: "true"
  pack:
    description: "If true, also enforce `agentsgen pack --autodetect --check`"
    required: false
    default: "false"
  pack_check:
    description: "Alias of pack: enforce `agentsgen pack --autodetect --check`"
    required: false
    default: "false"
  pack_format:
    description: "Pack check output format: text|json"
    required: false
    default: "json"
  pack_autodetect:
    description: "If true, run pack check with autodetect (otherwise pass --no-autodetect)"
    required: false
    default: "true"
  pack_llms_format:
    description: "Optional llms format override passed to pack check (txt|md)"
    required: false
    default: ""
  pack_output_dir:
    description: "Optional output directory override passed to pack check"
    required: false
    default: ""
  pack_files:
    description: "Optional newline/comma-separated pack output allowlist"
    required: false
    default: ""
  version:
    description: "Install mode: repo (default) or pypi"
    required: false
    default: "repo"

outputs:
  status:
    description: "ok or fail"
    value: ${{ steps.guard.outputs.status }}
  summary:
    description: "Short summary of result"
    value: ${{ steps.guard.outputs.summary }}

runs:
  using: "composite"
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install agentsgen
      shell: bash
      run: |
        set -euo pipefail
        python -m pip install --upgrade pip
        if [ "${{ inputs.version }}" = "pypi" ]; then
          python -m pip install agentsgen
        else
          REPO_ROOT="$(cd "${GITHUB_ACTION_PATH}/../../.." && pwd)"
          python -m pip install "${REPO_ROOT}"
        fi

    - name: Run guard
      id: guard
      shell: bash
      env:
        INPUT_PATH: ${{ inputs.path }}
        INPUT_FILES: ${{ inputs.files }}
        INPUT_COMMENT: ${{ inputs.comment }}
        INPUT_TOKEN: ${{ inputs.token }}
        INPUT_SHOW_COMMANDS: ${{ inputs.show_commands }}
        INPUT_PACK: ${{ inputs.pack }}
        INPUT_PACK_CHECK: ${{ inputs.pack_check }}
        INPUT_PACK_FORMAT: ${{ inputs.pack_format }}
        INPUT_PACK_AUTODETECT: ${{ inputs.pack_autodetect }}
        INPUT_PACK_LLMS_FORMAT: ${{ inputs.pack_llms_format }}
        INPUT_PACK_OUTPUT_DIR: ${{ inputs.pack_output_dir }}
        INPUT_PACK_FILES: ${{ inputs.pack_files }}
      run: |
        set -euo pipefail
        python "${GITHUB_ACTION_PATH}/guard.py"
